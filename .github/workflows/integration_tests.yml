name: Integration Tests

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'skia_builder/**'
      - 'tests/**'
      - 'setup.py'
      - '.github/workflows/integration-tests.yml'
  workflow_dispatch:

jobs:
  test-cli-basic:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'

    - name: Install skia-builder
      run: pip install .

    # Help commands
    - name: Test help commands
      run: |
        skia-builder --help
        skia-builder setup-env --help
        skia-builder build --help
        skia-builder list-available-args --help

    # Version arguments
    - name: Test version arguments
      shell: bash
      run: |
        # Test that arguments are accepted without error
        skia-builder setup-env --skia-version m145 --android-ndk r28 --help

    # Version validation warnings
    - name: Test version validation (below minimum)
      shell: bash
      run: |
        output=$(skia-builder setup-env --skia-version m100 --android-ndk r20 2>&1 || true)
        if [[ "$output" == *"below the minimum"* ]]; then
          echo "✓ Version validation warning working"
        else
          echo "✗ Version validation warning not found"
          exit 1
        fi
    
    # Invalid arguments
    - name: Test invalid architecture
      shell: bash
      run: |
        output="$(skia-builder build --target-cpu=invalid 2>&1 || true)"
        if echo "$output" | grep -q "Unsupported CPU architecture"; then
          echo "✓ Invalid architecture rejection working"
        else
          echo "✗ Should reject invalid architecture"
          exit 1
        fi

    # Missing required arguments
    - name: Test missing target-cpu
      shell: bash
      run: |
        output="$(skia-builder build 2>&1 || true)"
        if echo "$output" | grep -q "target-cpu must be specified"; then
          echo "✓ Missing argument check working"
        else
          echo "✗ Should require target-cpu"
          exit 1
        fi

  test-platform-specific:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux tests
          - os: ubuntu-latest
            test_name: "Linux x64"
            setup_cmd: "skia-builder setup-env"
            build_cmd: "skia-builder build --target-cpu=x64 --help"
          
          # macOS tests
          - os: macos-latest
            test_name: "macOS arm64"
            setup_cmd: "skia-builder setup-env"
            build_cmd: "skia-builder build --target-cpu=arm64 --help"
          
          - os: macos-latest
            test_name: "macOS x64"
            setup_cmd: "skia-builder setup-env"
            build_cmd: "skia-builder build --target-cpu=x64 --help"
          
          - os: macos-latest
            test_name: "iOS"
            setup_cmd: "skia-builder setup-env --sub-env=iOS"
            build_cmd: "skia-builder build --sub-env=iOS --target-cpu=arm64 --help"
          
          - os: macos-latest
            test_name: "iOS Simulator arm64"
            setup_cmd: "skia-builder setup-env --sub-env=iOSSimulator"
            build_cmd: "skia-builder build --sub-env=iOSSimulator --target-cpu=arm64 --help"
          
          - os: macos-latest
            test_name: "iOS Simulator x64"
            setup_cmd: "skia-builder setup-env --sub-env=iOSSimulator"
            build_cmd: "skia-builder build --sub-env=iOSSimulator --target-cpu=x64 --help"
          
          # Windows tests
          - os: windows-latest
            test_name: "Windows x64"
            setup_cmd: "skia-builder setup-env"
            build_cmd: "skia-builder build --target-cpu=x64 --help"
          
          - os: windows-latest
            test_name: "Android arm"
            setup_cmd: "skia-builder setup-env --sub-env=Android"
            build_cmd: "skia-builder build --sub-env=Android --target-cpu=arm --help"
          
          - os: windows-latest
            test_name: "Android arm64"
            setup_cmd: "skia-builder setup-env --sub-env=Android"
            build_cmd: "skia-builder build --sub-env=Android --target-cpu=arm64 --help"
          
          - os: windows-latest
            test_name: "Android x64"
            setup_cmd: "skia-builder setup-env --sub-env=Android"
            build_cmd: "skia-builder build --sub-env=Android --target-cpu=x64 --help"
          
          - os: windows-latest
            test_name: "Android x86"
            setup_cmd: "skia-builder setup-env --sub-env=Android"
            build_cmd: "skia-builder build --sub-env=Android --target-cpu=x86 --help"

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'

    - name: Install skia-builder
      run: pip install .

    - name: Test ${{ matrix.test_name }} - Setup
      run: ${{ matrix.setup_cmd }}
      # continue-on-error: true

    - name: Test ${{ matrix.test_name }} - Build
      run: ${{ matrix.build_cmd }}

  test-version-args:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            version_args: "--skia-version m145"
          - os: macos-latest
            version_args: "--skia-version m145"
          - os: windows-latest
            version_args: "--skia-version m145 --android-ndk r28"

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'

    - name: Install skia-builder
      run: pip install .

    - name: Test setup with version args
      run: skia-builder setup-env ${{ matrix.version_args }}
      # continue-on-error: true

  test-build-args-parsing:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'

    - name: Install skia-builder
      run: pip install .

    - name: Test custom build args parsing
      shell: bash
      run: |
        python -c "
        from skia_builder.config import parse_custom_build_args

        result = parse_custom_build_args(\"is_debug=false extra_cflags=['-O3']\")
        assert 'is_debug=false' in result
        assert 'extra_cflags=[\"-O3\"]' in result

        result = parse_custom_build_args(\"extra_cflags=['-g0'] is_debug=false is_component_build=false cc='clang'\")
        assert 'extra_cflags=[\"-g0\"]' in result
        assert 'is_debug=false' in result
        assert 'is_component_build=false' in result
        assert 'cc=\"clang\"' in result

        print('✓ Build args parsing working correctly')
        "

    - name: Test build args in CLI
      run: |
        skia-builder build --target-cpu=x64 --custom-build-args="is_debug=false" --help
        skia-builder build --target-cpu=x64 --override-build-args="skia_use_system_libjpeg_turbo=false" --help

  test-minimum-versions:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'

    - name: Install skia-builder
      run: pip install .

    - name: Verify minimum version constants
      run: |
        python -c "
        from skia_builder.versions import MIN_SKIA_VERSION, MIN_ANDROID_NDK_VERSION
        print(f'Minimum Skia: {MIN_SKIA_VERSION}')
        print(f'Minimum NDK: {MIN_ANDROID_NDK_VERSION}')
        assert MIN_SKIA_VERSION.startswith('m'), 'MIN_SKIA_VERSION should start with m'
        assert MIN_ANDROID_NDK_VERSION.startswith('r'), 'MIN_ANDROID_NDK_VERSION should start with r'
        print('✓ Minimum version constants valid')
        "

  test-list-available-args:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'

    - name: Install skia-builder
      run: pip install .

    - name: Test list-available-args command
      run: skia-builder list-available-args || echo "May fail without Skia checkout, this is expected"
      # continue-on-error: true

